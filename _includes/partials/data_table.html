{% assign entries = site.data.entries %}
{% assign datasets = site.data.datasets %}
{% assign places = site.data.places | sort: "2014_rank" %}
{% assign questions = site.data.questions %}
{% assign scope_dataset = include.dataset %}
{% assign scope_place = include.place %}
{% assign scope_year = include.year %}

{% if page.place %}
{% assign places = places | where: "slug", page.place %}
{% endif %}

<div class="row">
    <div class="col-md-8">
        {% include partials/data_table_tools.html %}
    </div>
    <div class="col-md-4">
        {% include partials/data_table_key.html %}
    </div>
</div>

<section class="data-display">
    <div class="row">
        <div class="col-md-12">
            <table id="index-table" class="table">
            <thead>
            {% include partials/data_table_header.html %}
            </thead>
            <tbody>
            {% for place in places %}

            {% if scope_year %}
            {% assign score_lookup = scope_year | append:"_score" %}
            {% assign rank_lookup = scope_year | append:"_rank" %}
            {% else %}
            {% assign score_lookup = site.odi.current_year | append:"_score" %}
            {% assign rank_lookup = scope_year | append:"_rank" %}
            {% endif %}

            <tr data-rank="{{ place[rank_lookup] }}" data-score="{{ place[score_lookup] }}" data-place="{{ place.slug }}">
                <td class="rank" data-rank="{{ place[rank_lookup] }}">
                    {{ place[rank_lookup] }}
                </td>
                <td>
                    <a href="{{ site.baseurl }}/places/{{ place.slug }}/" title="{{ place.name }}">
                        {{ place.name }}
                    </a>
                </td>
                {% for dataset in datasets %}
                <td>
                    {% assign entry = entries | where: "place", place.slug | where: "dataset", dataset.id | where: "year", scope_year | first %}
                    {% if entry %}

                    {% capture popover_title %}
                    <strong>{{ dataset.title }}</strong> in <strong>{{ place.name }}</strong>
                    {% endcapture %}

                    {% capture popover_content %}
                    <ul>
                        {% for question in questions %}
                        {% unless question.has_score != 'TRUE' %}
                        {% assign state = entry[question.id] %}
                        {% if state == 'Yes'%}
                        {% assign not == '' %}
                        {% elsif state == 'No' %}
                        {% assign not == 'not' %}
                        {% else %}
                        {% assign not == 'unclear if it\'s ' %}
                        {% endif %}
                        <li>
                            {% if question.id == 'exists' %}
                            {% if state == 'Yes' %}
                            Data Exists
                            {% else %}
                            Data does not exist
                            {% endif %}
                            {% elsif question.id == 'digital' %}
                            It's {{ not }} digital
                            {% elsif question.id == 'public' %}
                            It's {{ not }} public
                            {% elsif question.id == 'free' %}
                            It's {{ not }} free
                            {% elsif question.id == 'online' %}
                            It's {{ not }} online
                            {% if not == '' %}
                            <a href="{{ questions['url'] }}" title="{{ dataset.id }} for {{ place.name }} on the web">
                                here
                            </a>
                            {% endif %}
                            {% elsif question.id == 'machinereadable' %}
                            It's {{ not }} machine readable
                            {% elsif question.id == 'bulk' %}
                            It's {{ not }} available in bulk
                            {% elsif question.id == 'openlicense' %}
                            It's {{ not }} only licensed
                            {% elsif question.id == 'uptodate' %}
                            It's {{ not }} up to date
                            {% endif %}
                        </li>
                        {% endunless %}
                        {% endfor %}
                    </ul>
                    <p>
                        {{ entry.details | markdownify }}
                    </p>
                    <a href="{{ site.baseurl }}/places/{{ place.slug }}/datasets/{{ dataset.id }}/">
                        Read more &raquo;
                    </a>
                    {% endcapture %}

                    <ul class="availability availability-mini" data-toggle="popover" title="{{ popover_title | escape }}" data-content="{{ popover_content | escape }}">
                        {% for question in questions %}
                        {% unless question.has_score != 'TRUE' %}
                        {% assign state = entry[question.id] %}
                        <li class="{% if state == 'Yes' %}yes{% elsif state == 'No' %}no{% elsif state == '?' %}maybe{% endif %}" data-content="{{ state }}">&nbsp;</li>
                        {% endunless %}
                        {% endfor %}
                    </ul>

                    {% else %}

                    {% capture popover_title %}
                    <strong>{{ dataset.title }}</strong> in <strong>{{ place.name }}</strong>
                    {% endcapture %}

                    {% capture popover_content %}
                    There is no data available.
                    {% endcapture %}

                    <ul class="availability availability-mini" data-toggle="popover" title="{{ popover_title | escape }}" data-content="{{ popover_content | escape }}">
                        {% for question in questions %}
                        {% unless question.has_score != 'TRUE' %}
                        <li class="" data-content="no data">&nbsp;</li>
                        {% endunless %}
                        {% endfor %}
                    </ul>
                    {% endif %}
                </td>
                {% endfor %}
                <td class="score" data-score="{{ place[score_lookup] }}">
                    {{ place[score_lookup] }}
                </td>
            </tr>
            {% endfor %}
            </tbody>
            <tfoot>
            {% include partials/data_table_header.html %}
            </tfoot>
        </table>
        </div>
    </div>
</section>

<div class="row">
    <div class="col-md-8">
        &nbsp;
    </div>
    <div class="col-md-4">
        {% include partials/data_table_key.html %}
    </div>
</div>
