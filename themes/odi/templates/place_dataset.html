{% extends 'page.html' %}

{% from 'macros.html' import history, share, popover_slice_title, popover_slice_content %}
{% from '_scope.html' import scope with context %}

{% do scope.update({
  'embed_height': '460px',
  'embed_title': '%s / %s %s'|format(scope.place.name, scope.dataset.title, page.year),
  'panel_tools': 'false',
  'panel_share': 'false',
}) %}

{% set fragment = '%s/%s/%s'|format('place', scope.place.slug, scope.dataset.id) %}
{% set entry_previous = scope.entries|where('year', (scope.entry.year|int - 1)|string)|first %}

{% block heading %}{% endblock heading %}

{% block breadcrumbs_inner %}
  <li><a href="{{ SITEURL }}/places">{{ gettext('Places')}}</a></li>
  <li><a href="{{ SITEURL }}/place/{{ scope.place.slug }}/">{{ scope.place.name }}</a></li>
  <li class="active">{{ scope.dataset.title }}</li>
{% endblock breadcrumbs_inner %}

{% block content %}
<header id="place-intro" class="page-header">
  <div class="row">
    <div class="col-md-6">
      <h1>
        <a href="{{ SITEURL }}/place/{{ scope.place.slug }}/" title="">{{ scope.place.name }}</a> / <a href="{{ SITEURL }}/dataset/{{ scope.dataset.id }}/" title="">{{ scope.dataset.title }}</a>
        <span class="label label-default place-openness" data-score="{{ scope.entry.score or ODI.na }}">{{ scope.entry.score }}%</span>
      </h1>
      <p class="lead">
        <strong>#{{ scope.entry.rank }} {{ gettext('in the Index') }}</strong>
        {% if entry_previous and entry_previous.rank %}
          <br>
          <small>
            {% if entry_previous.rank|int >
               scope.entry.rank|int
            %}
            {{ scope.higher }}
            {% elif entry_previous.rank|int <
               scope.entry.rank|int
            %}
            {{ scope.lower }}
            {% else %}
            {{ scope.no_change }}
            {% endif %}
            from #{{ entry_previous.rank }} in {{ ODI.previous_year }}
          </small>
        {% endif %}
      </p>
      {{ page.content }}
      {{ history(page, ODI, fragment) }}
      {{ share(page, ODI, fragment) }}
    </div>
    <div class="col-md-6">
      <div id="map-container">
        {% include 'dataviews/embed_map.html' %}
      </div>
    </div>
  </div>
</header>

<section>
    {{ scope.dataset.description|markdown }}
</section>

<section>
    <h2>{{ gettext('%(dataset)s data in %(place)s', dataset=scope.dataset.title, place=scope.place.name) }}</h2>
    <hr />
    <div class="row">
        <div class="col-md-7">
            {% if scope.entry.url %}
            <p>
                <span class="label label-success">{{ gettext('Location') }}</span>&nbsp;&nbsp;<a href="{{ scope.entry.url }}" title="{{ gettext('%(dataset)s data for %(place)s', dataset=scope.dataset.title, place=scope.place.name) }}">{{ scope.entry.url }}</a>
            </p>
            {% endif %}
            {% if scope.entry.format %}
            <p>
                <span class="label label-success">{{ gettext('Format') }}</span>&nbsp;&nbsp;{{ scope.entry.format }}
            </p>
            {% endif %}
            {% if scope.entry.details %}
            {{ scope.entry.details|markdown }}
            {% endif %}
        </div>
        <div class="col-md-5">
            <ul class="availability-single">
            {% for question in scope.questions if question.score %}
                {% set state = scope.entry[question.id] %}

                <li class="{% if state == 'Y' %}yes{% elif state == 'N' %}no{% elif state == '?' %}maybe{% endif %}"
                    data-toggle="popover"
                    title="{{ popover_slice_title(question.question, state)|e|safe }}"
                    data-content="{{ popover_slice_content(question.description)|e|safe }}">
                    <i class="fa fa-{{ question.icon }}"></i>&nbsp;
                    {{ question.question }}? {% if state == 'Y' %}{{ gettext('Yes') }}{% elif state == 'N' %}{{ gettext('No') }}{% elif state == '?' %}{{ gettext('Unsure') }}{% endif %}
                </li>
            {% endfor %}
            </ul>
        </div>
    </div>
</section>
{% endblock content %}
